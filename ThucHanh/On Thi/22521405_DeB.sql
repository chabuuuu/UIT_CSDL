USE MASTER
IF EXISTS (SELECT * FROM SYS.DATABASES WHERE NAME = 'BAITHI')
BEGIN
	ALTER DATABASE BAITHI SET SINGLE_USER WITH ROLLBACK IMMEDIATE;
	DROP DATABASE BAITHI;
END
GO

CREATE DATABASE BAITHI
SET DATEFORMAT DMY

CREATE TABLE CANHO (
MACH VARCHAR(10) PRIMARY KEY, 
TOANHA NVARCHAR(20), 
DIENTICH INT, 
GIA MONEY
)

CREATE TABLE CUDAN (
CMND VARCHAR(10) PRIMARY KEY, 
HOTEN NVARCHAR(30),
NGSINH SMALLDATETIME, 
QUEQUAN NVARCHAR(30), 
NGNG NVARCHAR(30)
)

CREATE TABLE HOPDONG (
SOHD VARCHAR(10) PRIMARY KEY, 
MACH VARCHAR(10) FOREIGN KEY REFERENCES CANHO(MACH), 
CHUCH VARCHAR(10) FOREIGN KEY REFERENCES CUDAN(CMND), 
NGLAP SMALLDATETIME, 
DATCOC MONEY
)

CREATE TABLE CUTRU  (
SOHD VARCHAR(10), 
CMND VARCHAR(10), 
NGKB SMALLDATETIME,
CONSTRAINT PK_CUTRU PRIMARY KEY (SOHD, CMND),
CONSTRAINT FK_SOHD_CUTRU FOREIGN KEY (SOHD) REFERENCES HOPDONG(SOHD),
CONSTRAINT FK_CMND_CUTRU FOREIGN KEY (CMND) REFERENCES CUDAN(CMND)
)

-- Cau 2:
SET DATEFORMAT DMY
INSERT INTO CANHO VALUES('CH001', 'Sunview A', 76, 2.6)
INSERT INTO CANHO VALUES('CH002', 'E-home 3', 105, 4.2)
INSERT INTO CANHO VALUES('CH003', 'Bcons', 60, 1.5)

SET DATEFORMAT DMY

INSERT INTO CUDAN VALUES('321770071', 'Le Phan Vu Thuan', '01/05/1999 ', 'Ben Tre', 'Ca si')
INSERT INTO CUDAN VALUES('352460911', 'To Thuy Hang', '13/05/1999', 'An Giang', 'Ban hu tieu')
INSERT INTO CUDAN VALUES('341955653', 'Duong Hoang Khang', '27/05/1999 ', 'Dong Thap', 'Van dong vien')

INSERT INTO HOPDONG VALUES('1782', 'CH002', '341955653', '16/01/2018', 650)
INSERT INTO HOPDONG VALUES('4902', 'CH001', '341955653', '02/04/2018', 400)
INSERT INTO HOPDONG VALUES('3022', 'CH003', '321770071', '27/03/2018 ', 250)

INSERT INTO CUTRU VALUES('1782', '352460911', '25/11/2018')
INSERT INTO CUTRU VALUES('1782', '321770071', '25/11/2018')
INSERT INTO CUTRU VALUES('3022', '352460911', '11/10/2018')


-- Câu 3:
ALTER TABLE CANHO ADD CONSTRAINT CK_DIENTICH_CH 
CHECK (
	DIENTICH > 70 AND GIA > 2
	OR DIENTICH <= 70
)

-- Câu 4:
--Bang rang buoc:
-------------------------------------
--|         THEM   |  XOA  |  SUA     |
--|CANHO  |   -    |  -(*) | + (GIA)  |
--|HOPDONG|   +    |   -   | +(DatCoc)|

GO
CREATE TRIGGER TG_SUA_CANHO
ON CANHO 
FOR UPDATE
AS
BEGIN
	DECLARE @MACH VARCHAR(10), @GIA VARCHAR(10), @DATCOC VARCHAR(10)
	SELECT @MACH = MACH, @GIA = GIA FROM inserted
	IF (EXISTS (
		SELECT * FROM HOPDONG 
		WHERE MACH = @MACH AND DATCOC * 1000 < 15/100*@GIA
	) 
	)
	BEGIN
			PRINT N': Số tiền đặt cọc phải bằng 15% giá căn hộ trở lên'
			ROLLBACK TRAN
		END
	ELSE
	PRINT N'Cập nhật thành công'
END

GO
CREATE TRIGGER TG_HOPDONG_INSERT
ON HOPDONG 
FOR INSERT
AS
BEGIN
	DECLARE @MACH VARCHAR(10), @GIA VARCHAR(10), @DATCOC VARCHAR(10)
	SELECT @MACH = MACH, @DATCOC = DATCOC FROM inserted
	SELECT @GIA = GIA FROM CANHO WHERE @MACH = MACH
	IF (@DATCOC >= 0.15*@GIA*1000)
	PRINT N'Thêm thành công'
	ELSE
		BEGIN
			PRINT N'Số tiền đặt cọc phải bằng 15% giá căn hộ trở lên'
			ROLLBACK TRAN
		END
END
go

CREATE TRIGGER TG_HOPDONG_UPDATE
ON HOPDONG 
FOR UPDATE
AS
BEGIN
	DECLARE @MACH VARCHAR(10), @GIA VARCHAR(10), @DATCOC VARCHAR(10)
	SELECT @MACH = MACH, @DATCOC = DATCOC FROM inserted
	SELECT @GIA = GIA FROM CANHO WHERE @MACH = MACH
	IF (@DATCOC >= 0.15*@GIA*1000)
	PRINT N'Sửa thành công'
	ELSE
		BEGIN
			PRINT N'Số tiền đặt cọc phải bằng 15% giá căn hộ trở lên'
			ROLLBACK TRAN
		END
END

-- Câu 5:
SELECT C.MACH
FROM CANHO C, HOPDONG H
WHERE C.MACH = H.MACH 
AND MONTH(NGLAP) BETWEEN 1 AND 3
AND YEAR(NGLAP) = 2018
ORDER BY GIA DESC

--Câu 6:
SELECT TOP 1 WITH TIES MACH
FROM HOPDONG H, CUTRU C
WHERE H.SOHD = C.SOHD
	AND MONTH(NGKB) = 11 
	AND YEAR(NGKB) = 2018
GROUP BY MACH 
ORDER BY COUNT(CMND) DESC

-- Câu 7:
-- CU DAN MUA CAN HO - CU DAN MUA CAN HO DIEN TICH DUOI 70
SELECT CMND FROM CUTRU CT, HOPDONG HD, CANHO CH
WHERE CT.SOHD = HD.SOHD AND CH.MACH = HD.MACH
AND DIENTICH > 100
EXCEPT
SELECT CMND FROM CUTRU CT, HOPDONG HD, CANHO CH
WHERE CT.SOHD = HD.SOHD AND CH.MACH = HD.MACH
AND DIENTICH < 70
-- Câu 8:
SELECT CMND, HOTEN
FROM CUDAN CD
WHERE NOT EXISTS (
	SELECT * FROM CANHO CH
	WHERE GIA BETWEEN 2 AND 5
	AND NOT EXISTS (
		SELECT *
		FROM HOPDONG HD
		WHERE HD.CHUCH = CD.CMND AND 
		CH.MACH = HD.MACH 
		AND YEAR(NGLAP) = 2018
		)
	)
